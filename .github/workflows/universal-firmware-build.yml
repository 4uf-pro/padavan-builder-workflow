name: Build Padavan Firmware

on:
  workflow_dispatch:
    inputs:
      router_config:
        description: 'Выберите конфигурацию роутера из папки configs/'
        required: true
        default: 'asus-rt-n11p.config'
        type: choice
        options:
          - mi-r3gv2-ra4v2-rb02.config
          - asus-rt-n11p.config
          - asus-rt-n11pb1.config

jobs:
  build:
    name: Build Padavan
    runs-on: ubuntu-latest
    # Используем контейнер, где уже есть всё необходимое для сборки
    container: ://registry.gitlab.com
    
    env:
      BUILD_CONFIG: ${{ github.event.inputs.router_config }}
      PADAVAN_REPO: https://github.com
      # Ссылка на тулчейн (компилятор) из проверенного источника
      PADAVAN_TOOLCHAIN_URL: https://github.com

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare environment
        run: |
          # Разрешаем git работать в контейнере
          git config --global --add safe.directory '*'
          # Клонируем исходники Padavan
          git clone --depth=1 $PADAVAN_REPO padavan-ng

      - name: Download and Extract Toolchain
        run: |
          # Скачиваем готовый компилятор, чтобы не собирать его 2 часа
          wget -qO- "$PADAVAN_TOOLCHAIN_URL" | tar -C padavan-ng -xJ

      - name: Extract device information
        run: |
          # Вытягиваем Vendor и ID для красивого имени архива
          VENDOR=$(grep 'CONFIG_VENDOR=' configs/$BUILD_CONFIG | cut -d= -f2 | tr -d '"' | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]')
          PRODUCT=$(grep 'CONFIG_FIRMWARE_PRODUCT_ID=' configs/$BUILD_CONFIG | cut -d= -f2 | tr -d '"' | tr '[:upper:]' '[:lower:]' | tr -s ' _' '-' | tr -cd '[:alnum:]-')
          
          [[ -z "$VENDOR" ]] && VENDOR="unknown"
          [[ -z "$PRODUCT" ]] && PRODUCT="${BUILD_CONFIG%.config}"
          
          echo "VENDOR=$VENDOR" >> $GITHUB_ENV
          echo "PRODUCT=$PRODUCT" >> $GITHUB_ENV

      - name: Build firmware
        run: |
          # Копируем выбранный конфиг в дерево сборки
          cp configs/$BUILD_CONFIG padavan-ng/trunk/.config
          cd padavan-ng/trunk
          # Очистка и запуск сборки через правильный скрипт
          ./clear_tree.sh
          ./build_firmware.sh
          
          # Ищем готовый файл прошивки
          FW_FILE_NAME=$(find images -type f -regextype posix-extended -iregex ".*\.(trx|bin)$" | tail -1 | xargs basename)
          echo "FW_FILE_NAME=$FW_FILE_NAME" >> $GITHUB_ENV

      - name: Prepare artifacts
        run: |
          TIMESTAMP=$(date '+%Y%m%d-%H%M')
          ARCHIVE_NAME="padavan-${{ env.VENDOR }}-${{ env.PRODUCT }}-${TIMESTAMP}"
          mkdir -p release
          cp padavan-ng/trunk/images/${{ env.FW_FILE_NAME }} release/
          cp configs/$BUILD_CONFIG release/build.config
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: release/
